name: Docker Image Sync

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: 'source image (Docker Hub)'
        required: true
        default: 'vllm/vllm-omni:v0.12.0rc1' 
      target_tag:
        description: 'target Tag (GHCR)'
        required: true
        default: 'v0.12.0rc1'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: yzhu802/vllm-omni-sync 

jobs:
  sync-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Pull & Tag & Push
        run: |
          # 1. 从 Docker Hub 拉取 
          docker pull ${{ inputs.source_image }}
          
          # 2. 重新打标签为 GHCR 格式
          # 注意：GitHub 要求镜像名必须全是小写
          TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.target_tag }}"
          TARGET_IMAGE=$(echo "$TARGET_IMAGE" | tr '[:upper:]' '[:lower:]')
          
          docker tag ${{ inputs.source_image }} $TARGET_IMAGE
          
          # 3. 推送到 GHCR
          docker push $TARGET_IMAGE
          
          echo "✅ 同步完成！"
          echo "国内加速地址是:"
          echo "registry-cn-huabei1-internal.ebcloud.com/$TARGET_IMAGE"
